# BigCommerce Catalog Migrator

## Version 2.0 - Refactored & Improved Architecture üéâ

Copy your BigCommerce **catalog** from a **production** store to a **sandbox** (or any other BC store) using the V3 REST API.

### Features

- ‚úÖ Brands ‚Üí by name
- ‚úÖ Categories ‚Üí preserves parent ‚Üí child tree (path-based mapping)
- ‚úÖ Products ‚Üí base fields (skips `custom_url` to avoid collisions)
- ‚úÖ Options & Variants ‚Üí **idempotent** option creation, robust mapping, **auto‚Äëcreate missing option values**
- ‚úÖ Custom Fields ‚Üí **idempotent** (skip duplicates or overwrite by name)
- ‚úÖ Images ‚Üí tries `image_url` first, then **falls back to binary upload**
- ‚úÖ Pagination, 429 retry w/ backoff, id‚Äëremapping
- ‚úÖ Duplicate‚Äëname safe via **upsert by name** (configurable)
- ‚úÖ Variant SKUs ‚Üí **conflict‚Äësafe** creation (`suffix` / `blank` / `skip` strategies)
- ‚úÖ Inventory synchronization with Inventory API

### What's New in v2.0

- üèóÔ∏è **Modular Architecture**: Refactored from a single 847-line file into 17+ focused modules
- üì¶ **Better Organization**: Clear separation of concerns (config, API, services, migrators)
- üß™ **Testable**: Each component can be tested independently
- üîß **Maintainable**: Easier to understand, modify, and extend
- üìö **Well Documented**: Comprehensive architecture and migration guides
- üîÑ **100% Compatible**: All features work exactly the same as v1.0

> **Tech**: Node.js (ESM), Axios, Dotenv, FormData, mime-types.


---

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [What Gets Migrated](#what-gets-migrated)
- [Usage](#usage)
- [CLI filters & flags](#cli-filters--flags)
- [How It Works](#how-it-works)
- [Idempotency & Re‚Äëruns](#idempotency--re-runs)
- [Troubleshooting](#troubleshooting)
- [Caveats & Limitations](#caveats--limitations)
- [FAQ](#faq)
- [Project Structure](#project-structure)
- [Changelog](#changelog)
- [Contributing](#contributing)
- [License](#license)


---

## Prerequisites

- **Node.js 18+**
- BigCommerce **API Accounts** (one for each store):
  - **Source (production)**: *V2/V3 API Token* with at least:
    - Products: **Read**
    - Brands / Categories / Options / Product Images / Product Variants: **Read**
  - **Destination (sandbox)**: *V2/V3 API Token* with at least:
    - Products, Brands, Categories, Options, Product Images, Product Variants, Custom Fields: **Read/Write**
- Your **store hash** for both stores (e.g. `abc123` from `https://store-abc123.mybigcommerce.com/...`).


---

## Installation

```bash
git clone <this-repo>
cd bc-catalog-migrator
npm i
```

This project uses ESM (`"type": "module"`) in `package.json`.

### Requirements

- **Node.js 18+**
- BigCommerce API credentials (see Configuration below)


---

## Configuration

Create a `.env` file in the project root:

```ini
# --- SOURCE (production) ---
SRC_STORE_HASH=xxxxxxxx
SRC_ACCESS_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# Optional; script auto-normalizes to /stores/<hash>/v3 even if omitted:
SRC_BASE_URL=https://api.bigcommerce.com

# --- DESTINATION (sandbox) ---
DST_STORE_HASH=yyyyyyyy
DST_ACCESS_TOKEN=yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
DST_BASE_URL=https://api.bigcommerce.com

# --- Tuning & behavior ---
PAGE_SIZE=250
DRY_RUN=false

# Handle duplicate product names on destination: update | suffix | skip
NAME_DEDUP_STRATEGY=update
NAME_DEDUP_SUFFIX=" [sandbox]"

# Custom fields dedupe strategy: pair | overwrite_by_name
#  - pair = skip if same (name, value) exists
#  - overwrite_by_name = PUT value to the first field with same name
CF_DEDUP_STRATEGY=pair

# Variant SKU conflict strategy: suffix | blank | skip
#  - suffix = append VARIANT_SKU_SUFFIX (and -2, -3, ...) until unique
#  - blank  = create variant without a SKU
#  - skip   = skip creating this variant
VARIANT_SKU_STRATEGY=suffix
VARIANT_SKU_SUFFIX=-SBX
```

> **Tip:** You can omit `SRC_BASE_URL` / `DST_BASE_URL`. The script normalizes to `https://api.bigcommerce.com/stores/<hash>/v3`.


---

## What Gets Migrated

**Entities**
- **Brands**: matched/created by **name**.
- **Categories**: tree rebuilt parent ‚Üí child using **full path** matching.
- **Products**: name, type, SKU, description, weight, price/sale_price, brand/category mappings, visibility, availability, condition.
  - Skips `custom_url` to avoid sandbox conflicts.
- **Options & Variants**:
  - Options are **idempotent** per product: if an option with the same `display_name` already exists, it is **reused**.
  - Variant mapping uses **option display name + value label** with normalization (case/space/diacritics tolerant).
  - If a referenced value label isn‚Äôt present, the script **creates the missing value** first.
  - Variant creation is **SKU‚Äëconflict safe** (configurable strategy).
- **Custom Fields**:
  - Pair‚Äëdedupe (skip if exact same name+value exists) **or** overwrite by name (PUT).
- **Images**:
  - Tries `image_url` first (fast).
  - If refused by API/CDN, downloads and **uploads as multipart** (`image_file`) with verification.


---

## Usage

### Quick Start

```bash
# 1. Dry-run to preview (no changes made)
npm start -- --dry-run

# 2. Migrate specific product by name
npm start -- --write --only-name="Product Name"

# 3. Full migration
npm start -- --write
```

### Available Scripts

```bash
npm start           # Run migration with new architecture
npm run migrate     # Same as npm start
npm run legacy      # Use legacy v1.0 monolithic script
```

---

## CLI filters & flags

You can control which products run and how, straight from the command line.  
CLI flags override `.env` where relevant (e.g., `--dry-run` overrides `DRY_RUN`).

**Selection flags**
- `--only-id=ID1,ID2,...` ‚Äî process only these source product IDs.
- `--only-name="substring"` ‚Äî process products whose name **contains** this substring (case‚Äëinsensitive).
- `--name-regex="pattern"` ‚Äî process products whose name matches this JS regex (e.g., `"^Blue.*(Stool|Lamp)$"`).
- `--limit=N` ‚Äî process only the first N products after filtering.
- `--start-after-id=ID` ‚Äî skip source products with `id <= ID` (useful for resuming).

**Behavior flags**
- `--dry-run` ‚Äî force read‚Äëonly mode (overrides `DRY_RUN=true/false` in `.env`).
- `--write` ‚Äî force write mode (opposite of `--dry-run`).
- `--skip-images` ‚Äî do not upload/verify images.
- `--skip-custom-fields` ‚Äî do not upsert custom fields.

**Examples**
```bash
# Dry run a single product by name contains
node migrate.js --dry-run --only-name="Greek Key Porcelain Garden Stool"

# Migrate two specific IDs, write mode, skip images
node migrate.js --write --only-id=2724,2725 --skip-images

# Regex match + limit to first hit
node migrate.js --name-regex="^Blue.*(Stool|Lamp)$" --limit=1

# Resume after a known source id
node migrate.js --write --start-after-id=2000
```

---

## How It Works

### Request / Retry
- All API calls go through `requestWithRetry()` with **exponential backoff** on HTTP 429.

### Mapping details
- **Brands:** matched by `name`.
- **Categories:** matched by **canonical path** and created parent ‚Üí child.
- **Products:** base payload built from source; `inventory_tracking` switches to `'variant'` if variants exist.
- **Options (idempotent):**
  - Reuse if a destination option with the same `display_name` exists; else `POST`.
  - If API reports ‚Äúalready used‚Äù, refetch options and reuse.
- **Option Values (robust):**
  - Build on-demand value map for each destination option.
  - **Auto‚Äëcreate** missing value labels on the destination option when needed.
- **Variants (idempotent + conflict‚Äësafe):**
  - If a variant **SKU** already exists **on this product**, **PUT** (update) it.
  - If the SKU exists **elsewhere** in the catalog:
    - `suffix`: retry with `<sku><VARIANT_SKU_SUFFIX>` then `<sku><VARIANT_SKU_SUFFIX>-2`‚Ä¶
    - `blank`: create without SKU.
    - `skip`: skip this variant.
- **Custom Fields (idempotent):**
  - `pair` strategy: skip creating duplicate (name, value) pairs.
  - `overwrite_by_name` strategy: update existing field by name; otherwise create.
- **Images (resilient):**
  - Try `image_url` ‚Üí if 4xx, **download** and upload as `image_file` ‚Üí verify with `GET /images`.


---

## Idempotency & Re‚Äëruns

- **Products**: `upsert by name` prevents duplicates; choose `NAME_DEDUP_STRATEGY`.
- **Options**: creation is **dedupe‚Äëby‚Äëdisplay_name** per product.
- **Option Values**: created on demand only when missing.
- **Variants**: updated when SKU already on the product; SKU conflicts across the catalog are handled by strategy.
- **Custom Fields**: duplicates are skipped or overwritten (strategy).
- **Images**: don‚Äôt re‚Äëupload if already present? (verification step logs current count; you can extend with a hash check if needed).


---

## Troubleshooting

### 404 ‚ÄúThe route is not found, check the URL‚Äù
- Base URL is wrong. Remove `SRC_BASE_URL`/`DST_BASE_URL` or let the script normalize to:
  `https://api.bigcommerce.com/stores/<STORE_HASH>/v3`.
- Quick test:
  ```bash
  curl -s -H "X-Auth-Token: $SRC_ACCESS_TOKEN"   "https://api.bigcommerce.com/stores/$SRC_STORE_HASH/v3/catalog/summary"
  ```

### 409 ‚ÄúThe product name is a duplicate‚Äù
- Destination already has a product with that name.
- Set `NAME_DEDUP_STRATEGY=update` (or `suffix`/`skip`).

### 422 ‚ÄúInvalid field(s): option_values ‚Ä¶ must not be empty / id‚Äù
- Variants require **`{ option_id, id }`** for each option choice.
- If ‚Äúmust not be empty‚Äù, the source variant had no mappable options; the script **skips** it and logs the reason.

### 422 ‚ÄúThe display name ‚Ä¶ has already been used on this product.‚Äù
- The option already exists on the product. The script now **reuses existing options** via an idempotent ensure‚Äëoptions step.

### 422 ‚ÄúThe custom field ‚Ä¶ already exists‚Äù
- Duplicate (name, value). Handled by **`ensureCustomFieldsInDst`**; pick `CF_DEDUP_STRATEGY=pair` or `overwrite_by_name`.

### 409 ‚ÄúSku ‚Ä¶ is not unique‚Äù
- SKU exists elsewhere in the catalog. Handled by **VARIANT_SKU_STRATEGY** (`suffix`/`blank`/`skip`).

### Images not appearing
- Cross‚Äëstore CDN URLs may be rejected; the script **falls back** to binary upload and verifies count.

### 401 / 403
- Token is for the wrong store hash or missing permissions.

### 429
- Backoff & retry is automatic. Reduce `PAGE_SIZE` if it happens often.


---

## Caveats & Limitations

- **SEO URLs** (`custom_url`) are not copied.
- **Modifiers** (text/file/etc.), **metafields**, **channels**, **price lists**, **inventory locations**, complex rules are out of scope for this version.
- Destination product/variant IDs will differ from source.


---

## FAQ

**Q: Can I run it multiple times?**  
A: Yes. The script is **idempotent** across products, options, variants, custom fields, and images.

**Q: Does it preserve product IDs?**  
A: No ‚Äî destination IDs will differ. Mapping is by name/path/labels.

**Q: Can I migrate only certain categories?**  
A: Add a filter to the fetched `products` list (by `p.categories` or `p.name`).

**Q: What about product modifiers or metafields?**  
A: Not included by default; contributions welcome.


---

## Project Structure

```
BCProductMigration/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.js                    # Main entry point
‚îÇ   ‚îú‚îÄ‚îÄ config/                     # Configuration management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.js                  # Environment variables
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cli.js                  # CLI argument parser
‚îÇ   ‚îú‚îÄ‚îÄ api/                        # API communication layer
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ client.js               # BigCommerce API client, retry logic, pagination
‚îÇ   ‚îú‚îÄ‚îÄ utils/                      # Utility functions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ string.js               # String normalization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ array.js                # Array utilities
‚îÇ   ‚îú‚îÄ‚îÄ models/                     # Data models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.js              # Product model
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ category.js             # Category model
‚îÇ   ‚îú‚îÄ‚îÄ services/                   # Business services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inventory.js            # Inventory operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image.js                # Image upload
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customFields.js         # Custom fields
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ options.js              # Options and variants
‚îÇ   ‚îî‚îÄ‚îÄ migrators/                  # Migration orchestration
‚îÇ       ‚îú‚îÄ‚îÄ brands.js               # Brand migration
‚îÇ       ‚îú‚îÄ‚îÄ categories.js           # Category migration
‚îÇ       ‚îú‚îÄ‚îÄ products.js             # Product migration
‚îÇ       ‚îú‚îÄ‚îÄ productFetcher.js       # Product fetching
‚îÇ       ‚îú‚îÄ‚îÄ productUpsert.js        # Product upsert
‚îÇ       ‚îî‚îÄ‚îÄ variants.js             # Variant migration
‚îú‚îÄ‚îÄ migrate.js                      # Legacy v1.0 script (kept for reference)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ README.md                       # This file
‚îú‚îÄ‚îÄ ARCHITECTURE.md                 # Technical architecture documentation
‚îî‚îÄ‚îÄ MIGRATION_GUIDE.md              # v1.0 to v2.0 migration guide
```

### Key Components

**Configuration Layer**: Centralized management of environment variables and CLI arguments

**API Layer**: HTTP client with automatic retry, rate limiting, and pagination

**Services Layer**: Reusable business logic for inventory, images, custom fields, and options

**Migrators Layer**: High-level orchestration for each entity type (brands, categories, products)

**Models Layer**: Data transformation and business rules


---

## Changelog

### 2.0 - Architecture Refactor (Current)
- üèóÔ∏è **Complete architectural refactor**: Modular design with clear separation of concerns
- üì¶ **17+ focused modules**: Replaced single 847-line file with organized structure
- üß™ **Testable components**: Each module can be tested independently
- üìö **Comprehensive documentation**: Added ARCHITECTURE.md and MIGRATION_GUIDE.md
- üîÑ **100% compatible**: All features work exactly as in v1.0
- üîß **Maintainable**: Easier to understand, modify, and extend
- ‚úÖ **Legacy support**: Original migrate.js kept for reference

### 1.2
- **CLI**: add `--dry-run`, `--write`, `--only-id`, `--only-name`, `--name-regex`, `--limit`, `--start-after-id`, `--skip-images`, `--skip-custom-fields`.

### 1.1
- **Options:** idempotent creation (reuse existing by `display_name`), robust indexing.
- **Variants:** conflict‚Äësafe SKU handling (`suffix`/`blank`/`skip`), update‚Äëin‚Äëplace if SKU already on product.
- **Custom Fields:** idempotent; (name,value) pair‚Äëdedupe or overwrite‚Äëby‚Äëname.
- **Images:** added binary upload fallback + verification.
- **URL Normalization:** resilient base URL builder for `/stores/<hash>/v3`.
- **Upsert by Name:** products update instead of creating duplicates.
- **Logging:** clearer per‚Äëentity diagnostics (skips, conflicts, creations).

### 1.0
- Initial migration for brands, categories, products, variants, custom fields, images.


---

## Documentation

üìñ **User Guides**
- [README.md](README.md) - This file: Quick start and usage guide
- [Configuration Guide](#configuration) - Environment variables and settings

üèóÔ∏è **Technical Documentation**
- [ARCHITECTURE.md](ARCHITECTURE.md) - System architecture and design principles
- [MIGRATION_GUIDE.md](MIGRATION_GUIDE.md) - Migrating from v1.0 to v2.0

---

## Contributing

PRs and issues are welcome. If you add support for modifiers/metafields/channels, please include:
- API endpoints used,
- example payloads,
- and the migration order of dependent entities.

### Development Guide

The modular architecture makes it easy to extend:

**To add a new entity type (e.g., Customers):**
1. Create model: `src/models/customers.js`
2. Create service (if needed): `src/services/customers.js`
3. Create migrator: `src/migrators/customers.js`
4. Import and call from `src/index.js`

**To add a new strategy:**
1. Add config option: `src/config/env.js`
2. Implement logic in relevant service
3. Use in migrator

See [ARCHITECTURE.md](ARCHITECTURE.md) for detailed technical documentation.

---

## License

MIT ¬© Your Name
